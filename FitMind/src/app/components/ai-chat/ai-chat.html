<div class="ai-chat-container">
  <div class="chat-header">
    <h3>ğŸ¤– FitMind AI Coach - Tvoj OsobnÃ½ TrÃ©ner</h3>
    <div class="header-buttons">
      <button (click)="toggleInsights()" class="insights-btn" title="ZobraziÅ¥ moje Å¡tatistiky">
        ğŸ“Š {{ showInsights ? 'SkryÅ¥' : 'Moje pokroky' }}
      </button>
      <button (click)="clearChat()" class="clear-btn" title="VyÄistiÅ¥ konverzÃ¡ciu">ğŸ—‘ï¸</button>
    </div>
  </div>

  <!-- Panel s pokrokmi a odporÃºÄaniami -->
  @if (showInsights && userId) {
    <div class="insights-panel">
      <div class="insights-tabs">
        <button 
          [class.active]="activeTab === 'recommendations'" 
          (click)="activeTab = 'recommendations'; loadRecommendations()">
          ğŸ’¡ OdporÃºÄania
        </button>
        <button 
          [class.active]="activeTab === 'weekly'" 
          (click)="activeTab = 'weekly'; loadWeeklyReport()">
          ğŸ“… Tento tÃ½Å¾deÅˆ
        </button>
        <button 
          [class.active]="activeTab === 'goals'" 
          (click)="activeTab = 'goals'; loadGoalProgress()">
          ğŸ¯ Moje ciele
        </button>
      </div>

      <div class="insights-content">
        <!-- OdporÃºÄania -->
        @if (activeTab === 'recommendations') {
          <div class="recommendations-view">
            <h4>PersonalizovanÃ© odporÃºÄania pre teba</h4>
            @if (loadingInsights) {
              <div class="loading">NaÄÃ­tavam...</div>
            } @else if (recommendations.length > 0) {
              <ul class="recommendations-list">
                @for (rec of recommendations; track rec) {
                  <li>{{ rec }}</li>
                }
              </ul>
            } @else {
              <p class="no-data">ZatiaÄ¾ Å¾iadne odporÃºÄania. ZaÄni zaznamenÃ¡vaÅ¥ jedlo a cviÄenie!</p>
            }
          </div>
        }

        <!-- TÃ½Å¾dennÃ½ report -->
        @if (activeTab === 'weekly') {
          <div class="weekly-report-view">
            <h4>TÃ½Å¾dennÃ½ report</h4>
            @if (loadingInsights) {
              <div class="loading">NaÄÃ­tavam...</div>
            } @else if (weeklyReport) {
              <div class="report-summary">
                <div class="overall-message" [class]="weeklyReport.overall_rating">
                  {{ weeklyReport.overall_message }}
                </div>
                
                @if (weeklyReport.achievements.length > 0) {
                  <div class="achievements-section">
                    <h5>ğŸ† Ãšspechy</h5>
                    <ul>
                      @for (achievement of weeklyReport.achievements; track achievement) {
                        <li>{{ achievement }}</li>
                      }
                    </ul>
                  </div>
                }

                @if (weeklyReport.areas_to_improve.length > 0) {
                  <div class="improvements-section">
                    <h5>âš ï¸ Oblasti na zlepÅ¡enie</h5>
                    <ul>
                      @for (area of weeklyReport.areas_to_improve; track area) {
                        <li>{{ area }}</li>
                      }
                    </ul>
                  </div>
                }

                @if (weeklyReport.recommendations.length > 0) {
                  <div class="recommendations-section">
                    <h5>ğŸ’¡ OdporÃºÄania</h5>
                    <ul>
                      @for (rec of weeklyReport.recommendations; track rec) {
                        <li>{{ rec }}</li>
                      }
                    </ul>
                  </div>
                }
              </div>
            } @else {
              <p class="no-data">Nedostatok dÃ¡t pre report. ZaznamenÃ¡vaj jedlo a cviÄenie aspoÅˆ 3 dni!</p>
            }
          </div>
        }

        <!-- Pokrok k cieÄ¾om -->
        @if (activeTab === 'goals') {
          <div class="goals-view">
            <h4>Pokrok k mojim cieÄ¾om</h4>
            @if (loadingInsights) {
              <div class="loading">NaÄÃ­tavam...</div>
            } @else if (goalProgress && goalProgress.progress_items.length > 0) {
              <div class="goals-list">
                @for (item of goalProgress.progress_items; track item.goal) {
                  <div class="goal-item" [class.on-track]="item.on_track">
                    <div class="goal-header">
                      <strong>{{ item.goal }}</strong>
                      <span [class.positive]="item.on_track" [class.negative]="!item.on_track">
                        {{ item.on_track ? 'âœ…' : 'âš ï¸' }}
                      </span>
                    </div>
                    <div class="goal-stats">
                      <span>CieÄ¾: {{ item.target }}</span>
                      <span>AktuÃ¡lne: {{ item.current }}</span>
                      <span class="difference">{{ item.difference }}</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="item.percentage > 100 ? 100 : item.percentage"></div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="no-data">Nastav si ciele v profile! ChoÄ do Nastavenia â†’ Profil.</p>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- NotifikÃ¡cie o uloÅ¾enÃ½ch zÃ¡znamoch -->
  @if (savedEntries.length > 0) {
    <div class="saved-entries-notification">
      @for (entry of savedEntries; track entry) {
        <div class="saved-entry-badge">
          {{ entry }}
        </div>
      }
    </div>
  }

  <!-- Varovanie ak nie je prihlÃ¡senÃ½ -->
  @if (!userId) {
    <div class="warning-message">
      âš ï¸ Pre pouÅ¾itie AI coacha sa musÃ­te prihlÃ¡siÅ¥
    </div>
  }

  <!-- Varovanie ak backend nebeÅ¾Ã­ -->
  @if (!backendRunning && userId) {
    <div class="warning-message backend-warning">
      âš ï¸ Backend server nebeÅ¾Ã­! Spusti backend v terminÃ¡li: <code>cd backend && python main.py</code>
    </div>
  }

  <div class="messages-container">
    @for (msg of aiService.messages$ | async; track msg.timestamp) {
      <div [ngClass]="{ 'user-message': msg.role === 'user', 'ai-message': msg.role === 'assistant' }">
        <div class="message-bubble">
          @if (msg.role === 'user') {
            <strong>ğŸ‘¤ Ty:</strong>
          }
          @if (msg.role === 'assistant') {
            <strong>ğŸ¤– AI:</strong>
          }
          <div class="message-content">{{ msg.content }}</div>
          <small class="timestamp">{{ msg.timestamp | date:'short' }}</small>
        </div>
      </div>
    }

    @if (isLoading) {
      <div class="loading">AI pÃ­Å¡e...</div>
    }
  </div>

  <div class="input-container">
    <input 
      [(ngModel)]="message" 
      (keyup.enter)="sendMessage()" 
      placeholder="NapÃ­Å¡ AI coachovi (napr. 'Zjedol som raÅˆajky: 2 vajÃ­Äka, 200 kcal')..." 
      [disabled]="isLoading || !userId">
    <button (click)="sendMessage()" [disabled]="isLoading || !message.trim() || !userId">
      {{ isLoading ? 'â³' : 'ğŸ“¤' }}
    </button>
  </div>
</div>
